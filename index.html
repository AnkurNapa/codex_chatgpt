<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrewERP - Brewery ERP MVP</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #2f855a;
      --accent-2: #0ea5e9;
      --border: #e5e7eb;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
      --radius: 12px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    h1, h2, h3, h4 { margin: 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; font-size: 0.92rem; }

    .app { min-height: 100vh; display: flex; flex-direction: column; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 8;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #0f172a;
    }

    .brand .mark {
      width: 12px;
      height: 12px;
      border-radius: 4px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: inline-block;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      min-width: 240px;
      background: #f9fafb;
    }

    .btn {
      border: none;
      background: linear-gradient(135deg, var(--accent), #16a34a);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    .btn.secondary { background: #111827; box-shadow: none; }
    .btn.flat { background: #e5e7eb; color: #111827; box-shadow: none; }

    .btn:hover { transform: translateY(-1px); }

    .layout { display: grid; grid-template-columns: 230px 1fr; min-height: calc(100vh - 64px); }

    aside {
      background: #0f172a;
      color: #e5e7eb;
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .nav-button {
      border: none;
      background: transparent;
      color: inherit;
      text-align: left;
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }

    .nav-button.active, .nav-button:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(2px); }

    main { padding: 18px; }

    .section { display: none; }
    .section.active { display: block; }

    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 18px;
      border: 1px solid var(--border);
    }

    .panel h2 { margin-bottom: 10px; letter-spacing: 0.1px; }

    .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }

    .kpi { padding: 14px; border-radius: var(--radius); background: linear-gradient(135deg, #ecfdf3, #e0f2fe); border: 1px solid #d1fae5; }
    .kpi h3 { margin: 0; font-size: 0.95rem; color: var(--muted); }
    .kpi .value { font-size: 1.8rem; font-weight: 800; margin-top: 4px; }

    .tag { padding: 4px 8px; background: #e5e7eb; border-radius: 999px; font-size: 0.8rem; font-weight: 700; }
    .status-good { background: #dcfce7; color: #166534; }
    .status-warn { background: #fef9c3; color: #854d0e; }
    .status-bad { background: #fee2e2; color: #991b1b; }

    .table-wrapper { overflow-x: auto; }

    .muted { color: var(--muted); }

    form { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; align-items: end; }
    form input, form select, form textarea {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #f9fafb;
    }

    .low-stock { background: #fef2f2; }
    .detail { background: #f8fafc; border-radius: 10px; padding: 12px; border: 1px dashed var(--border); margin-top: 12px; }

    .flex-between { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }

    canvas { width: 100%; max-width: 680px; height: 280px; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      aside { flex-direction: row; flex-wrap: wrap; position: sticky; top: 60px; z-index: 7; }
      .nav-button { flex: 1 1 45%; }
      .topbar { flex-direction: column; align-items: flex-start; gap: 12px; }
      .search { width: 100%; }
      .search input { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand"><span class="mark"></span> BrewERP</div>
      <div class="search">
        <input id="batchSearch" type="text" placeholder="Search Batch ID (e.g., BREW-042)" />
        <button class="btn" id="searchBtn">Search</button>
      </div>
    </header>

    <div class="layout">
      <aside>
        <button class="nav-button active" data-section="dashboard">Dashboard</button>
        <button class="nav-button" data-section="materials">Raw Materials</button>
        <button class="nav-button" data-section="recipes">Recipe Management</button>
        <button class="nav-button" data-section="brewhouse">Brewing Log</button>
        <button class="nav-button" data-section="fermentation">Fermentation</button>
        <button class="nav-button" data-section="filtration">Filtration & Conditioning</button>
        <button class="nav-button" data-section="inventory">Inventory & Finished Goods</button>
        <button class="nav-button" data-section="analytics">Analytics / Reports</button>
      </aside>

      <main>
        <section id="dashboard" class="section active">
          <div class="panel">
            <div class="flex-between">
              <h2>Command Center</h2>
              <span class="muted" id="searchResult">Type a batch ID to jump to details.</span>
            </div>
            <div class="grid-4 grid-3" id="kpiGrid">
              <div class="kpi"><h3>Total Batches</h3><div class="value" id="kpiBatches">0</div></div>
              <div class="kpi"><h3>Active Fermentations</h3><div class="value" id="kpiActive">0</div></div>
              <div class="kpi"><h3>Avg Brewhouse Eff.</h3><div class="value" id="kpiEff">0%</div></div>
              <div class="kpi"><h3>Total Volume Brewed</h3><div class="value" id="kpiVolume">0 HL</div></div>
            </div>
          </div>

          <div class="panel">
            <div class="grid-3">
              <div class="detail"><strong>Brewhouse Efficiency</strong><div id="efficiencyCard" class="muted">--%</div></div>
              <div class="detail"><strong>Tank Utilization</strong><div id="tankUtilization" class="muted">--%</div></div>
              <div class="detail"><strong>Monthly Production Volume</strong><div id="monthlyVolume" class="muted">-- HL (last 90 days)</div></div>
            </div>
          </div>

          <div class="panel">
            <div class="flex-between"><h2>Active Fermentations</h2><span class="muted">Live view of cellar</span></div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr><th>Batch ID</th><th>Beer Style</th><th>Tank</th><th>Days Fermenting</th><th>Status</th></tr>
                </thead>
                <tbody id="activeFermentations"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="materials" class="section">
          <div class="panel">
            <div class="flex-between"><h2>Raw Materials</h2><span class="muted">Add and monitor stocks</span></div>
            <form id="materialForm">
              <input name="materialId" required placeholder="Material ID" />
              <input name="name" required placeholder="Name" />
              <select name="type" required>
                <option value="Malt">Malt</option><option value="Hops">Hops</option><option value="Yeast">Yeast</option><option value="Adjunct">Adjunct</option><option value="Chemical">Chemical</option><option value="Packaging">Packaging</option>
              </select>
              <input name="currentStock" required type="number" step="0.01" placeholder="Current Stock" />
              <input name="minStock" required type="number" step="0.01" placeholder="Min Stock" />
              <input name="supplier" required placeholder="Supplier" />
              <input name="unitCost" required type="number" step="0.01" placeholder="Unit Cost" />
              <button class="btn" type="submit">Add Material</button>
            </form>
          </div>
          <div class="panel table-wrapper">
            <table>
              <thead><tr><th>Material ID</th><th>Name</th><th>Type</th><th>Current Stock</th><th>Min Stock</th><th>Supplier</th><th>Unit Cost</th></tr></thead>
              <tbody id="materialsTable"></tbody>
            </table>
          </div>
        </section>

        <section id="recipes" class="section">
          <div class="panel">
            <div class="flex-between"><h2>Recipe Management</h2><span class="muted">Click to view details</span></div>
            <div class="table-wrapper">
              <table>
                <thead><tr><th>Recipe ID</th><th>Name</th><th>Beer Style</th><th>Version</th><th>Target OG</th><th>Target FG</th><th>Target ABV</th></tr></thead>
                <tbody id="recipesTable"></tbody>
              </table>
            </div>
            <div id="recipeDetail" class="detail">Select a recipe to see mash, hop schedule, and notes.</div>
          </div>
        </section>

        <section id="brewhouse" class="section">
          <div class="panel">
            <div class="flex-between"><h2>Brewing Log</h2>
              <select id="brewFilter">
                <option value="All">All Styles</option>
              </select>
            </div>
            <form id="brewForm">
              <input name="batchId" required placeholder="Batch ID" />
              <input name="recipeName" required placeholder="Recipe Name" />
              <select name="beerStyle" required id="brewStyle"></select>
              <input name="brewDate" required type="date" />
              <input name="og" required step="0.001" type="number" placeholder="OG" />
              <input name="efficiency" required step="0.1" type="number" placeholder="Efficiency %" />
              <input name="volume" required step="0.1" type="number" placeholder="Volume (HL)" />
              <button class="btn" type="submit">Add Brew Log</button>
            </form>
          </div>
          <div class="panel table-wrapper">
            <table>
              <thead><tr><th>Batch ID</th><th>Recipe</th><th>Style</th><th>Brew Date</th><th>OG</th><th>Efficiency</th><th>Volume (HL)</th></tr></thead>
              <tbody id="brewTable"></tbody>
            </table>
          </div>
        </section>

        <section id="fermentation" class="section">
          <div class="panel">
            <h2>Fermentation Monitoring</h2>
            <div class="table-wrapper">
              <table>
                <thead><tr><th>Batch ID</th><th>Beer Style</th><th>Tank ID</th><th>Start Date</th><th>Days Fermenting</th><th>Current Gravity</th><th>Status</th></tr></thead>
                <tbody id="fermentationTable"></tbody>
              </table>
            </div>
            <div id="fermentationDetail" class="detail">Click a row to view gravity history and actions.</div>
          </div>
        </section>

        <section id="filtration" class="section">
          <div class="panel table-wrapper">
            <div class="flex-between"><h2>Filtration & Conditioning</h2><span class="muted">Yield calculated automatically</span></div>
            <table>
              <thead><tr><th>Batch ID</th><th>Filter Date</th><th>Method</th><th>Pre-Filter Volume</th><th>Post-Filter Volume</th><th>Yield (%)</th></tr></thead>
              <tbody id="filtrationTable"></tbody>
            </table>
          </div>
        </section>

        <section id="inventory" class="section">
          <div class="panel table-wrapper">
            <h2>Finished Beer Inventory</h2>
            <table>
              <thead><tr><th>Beer Name</th><th>Beer Style</th><th>Batch IDs</th><th>Pack Type</th><th>Quantity in Stock</th></tr></thead>
              <tbody id="inventoryTable"></tbody>
            </table>
          </div>
          <div class="panel table-wrapper">
            <h2>Packaging Materials</h2>
            <table>
              <thead><tr><th>Item</th><th>Quantity</th><th>Minimum Level</th></tr></thead>
              <tbody id="packagingTable"></tbody>
            </table>
          </div>
        </section>

        <section id="analytics" class="section">
          <div class="panel">
            <h2>Analytics & Reports</h2>
            <div class="grid-2">
              <div>
                <h4>Average ABV by Style</h4>
                <ul id="avgAbv" class="muted"></ul>
              </div>
              <div>
                <h4>Average Efficiency by Style</h4>
                <ul id="avgEff" class="muted"></ul>
              </div>
            </div>
            <div class="detail" style="margin-top:14px;">
              <strong>Total Production Volume (HL) by Style</strong>
              <ul id="totalVolume" class="muted"></ul>
              <canvas id="volumeChart" width="700" height="320"></canvas>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // Data seeds
    const beerStyles = ["IPA", "Hazy IPA", "Pale Ale", "Pilsner", "Hefeweizen", "Stout", "Porter", "Saison", "Belgian Tripel", "Amber Lager", "Witbier", "Sour Ale"];
    const recipeNames = ["West Coast Punch", "Citrus Haze", "Keller Gold", "Velvet Stout", "Midnight Porter", "Spring Saison", "Tripel Star", "Amber Horizon", "Cloudy Wit", "Sunset Sour", "Hefeland", "Cascade Pale"];

    function pad(num) { return num.toString().padStart(3, "0"); }
    function randomChoice(list) { return list[Math.floor(Math.random() * list.length)]; }

    function generateBatches() {
      const batches = [];
      const today = new Date();
      const tankIds = ["F01","F02","F03","F04","F05","F06","F07","F08","F09","F10","F11","F12"];
      for (let i = 1; i <= 100; i++) {
        const style = randomChoice(beerStyles);
        const recipeName = randomChoice(recipeNames);
        const brewDate = new Date(today);
        brewDate.setDate(brewDate.getDate() - Math.floor(Math.random() * 220));
        const og = +(1.050 + Math.random() * 0.028).toFixed(3);
        const fg = +(og - (0.010 + Math.random() * 0.010)).toFixed(3);
        const abv = +(((og - fg) * 131).toFixed(1));
        const volumeHl = +(15 + Math.random() * 15).toFixed(1);
        const brewhouseEfficiency = +(78 + Math.random() * 14).toFixed(1);
        const fermentationStart = new Date(brewDate);
        fermentationStart.setDate(fermentationStart.getDate() + 1);
        const daysFermenting = Math.max(1, Math.floor((today - fermentationStart) / (1000*60*60*24)));
        const statusPool = daysFermenting < 7 ? ["Primary","On Track","Slow"] : daysFermenting < 14 ? ["Conditioning","Ready for Crash","On Track"] : ["Conditioning","Carbonating","Complete"];
        const status = randomChoice(statusPool);
        const currentGravity = +(fg + Math.random() * 0.006).toFixed(3);
        batches.push({
          batchId: `BREW-${pad(i)}`,
          recipeName,
          beerStyle: style,
          brewDate: brewDate.toISOString().slice(0,10),
          og,
          fg,
          abv,
          volumeHl,
          brewhouseEfficiency,
          tankId: randomChoice(tankIds),
          fermentationStartDate: fermentationStart.toISOString().slice(0,10),
          fermentationDays: daysFermenting,
          currentGravity,
          status
        });
      }
      return batches;
    }

    const batches = generateBatches();

    let materials = [
      { materialId: "MALT-001", name: "Pilsner Malt", type: "Malt", currentStock: 820, minStock: 400, supplier: "Northern Grains", unitCost: 0.92 },
      { materialId: "MALT-002", name: "Maris Otter", type: "Malt", currentStock: 210, minStock: 350, supplier: "Heritage Malting", unitCost: 1.05 },
      { materialId: "HOPS-101", name: "Citra", type: "Hops", currentStock: 48, minStock: 60, supplier: "Yakima Gold", unitCost: 24.5 },
      { materialId: "HOPS-102", name: "Mosaic", type: "Hops", currentStock: 33, minStock: 40, supplier: "HBC", unitCost: 23.0 },
      { materialId: "YEAST-01", name: "US-05", type: "Yeast", currentStock: 12, minStock: 8, supplier: "Fermentis", unitCost: 3.4 },
      { materialId: "CHEM-10", name: "CaCl2", type: "Chemical", currentStock: 5, minStock: 5, supplier: "BrewChem", unitCost: 1.8 },
      { materialId: "ADJ-01", name: "Lactose", type: "Adjunct", currentStock: 18, minStock: 25, supplier: "Milk & Grain", unitCost: 2.2 },
      { materialId: "PKG-50", name: "30L Keg", type: "Packaging", currentStock: 140, minStock: 80, supplier: "KegWorld", unitCost: 85 },
      { materialId: "PKG-20", name: "440ml Can", type: "Packaging", currentStock: 12000, minStock: 10000, supplier: "CanWorks", unitCost: 0.18 },
      { materialId: "PKG-10", name: "Bottle Crown", type: "Packaging", currentStock: 18000, minStock: 8000, supplier: "Seal Co.", unitCost: 0.04 }
    ];

    let recipes = [
      { id: "R-001", name: "West Coast Punch", style: "IPA", version: 3, og: 1.062, fg: 1.012, abv: 6.6,
        maltBill: [{item:"2-Row", amount:"65%"}, {item:"Munich", amount:"15%"}, {item:"Carapils", amount:"5%"}],
        hopSchedule: [{name:"Columbus", time:"60 min"},{name:"Simcoe", time:"15 min"},{name:"Citra", time:"Whirlpool"}],
        yeast:"US-05", mashSchedule:"Mash 60 min @ 66°C, mash-out 76°C", notes:"Classic pine and citrus bitterness." },
      { id: "R-002", name: "Citrus Haze", style: "Hazy IPA", version: 2, og: 1.066, fg: 1.014, abv: 6.8,
        maltBill: [{item:"Golden Promise", amount:"55%"}, {item:"Wheat", amount:"20%"}, {item:"Oats", amount:"15%"}],
        hopSchedule: [{name:"Mosaic", time:"Whirlpool"},{name:"Citra", time:"Dry Hop Day 3"}],
        yeast:"London III", mashSchedule:"Mash 45 min @ 67°C", notes:"Soft mouthfeel, huge tropical notes." },
      { id: "R-003", name: "Keller Gold", style: "Pilsner", version: 4, og: 1.050, fg: 1.010, abv: 5.2,
        maltBill: [{item:"Pilsner", amount:"95%"}, {item:"Carapils", amount:"3%"}],
        hopSchedule: [{name:"Hallertau", time:"60 min"},{name:"Saaz", time:"10 min"}],
        yeast:"34/70", mashSchedule:"Step mash 62°C 30m, 68°C 30m", notes:"Crisp and bitter, natural carbonation." },
      { id: "R-004", name: "Velvet Stout", style: "Stout", version: 1, og: 1.065, fg: 1.018, abv: 6.1,
        maltBill: [{item:"Maris Otter", amount:"70%"},{item:"Roasted Barley", amount:"8%"},{item:"Flaked Barley", amount:"10%"}],
        hopSchedule: [{name:"East Kent Goldings", time:"60 min"}],
        yeast:"Irish Ale", mashSchedule:"Mash 60 min @ 67°C", notes:"Silky body with chocolate finish." },
      { id: "R-005", name: "Spring Saison", style: "Saison", version: 5, og: 1.054, fg: 1.006, abv: 6.3,
        maltBill: [{item:"Pilsner", amount:"70%"},{item:"Spelt", amount:"18%"}],
        hopSchedule: [{name:"Styrian Goldings", time:"30 min"}],
        yeast:"French Saison", mashSchedule:"Mash 90 min @ 65°C", notes:"Peppery ester profile, dry finish." },
      { id: "R-006", name: "Sunset Sour", style: "Sour Ale", version: 2, og: 1.048, fg: 1.008, abv: 5.3,
        maltBill: [{item:"Pilsner", amount:"60%"},{item:"Wheat", amount:"25%"}],
        hopSchedule: [{name:"Cascade", time:"5 min"}],
        yeast:"Lacto + US-05", mashSchedule:"Quick souring, boil 15 min", notes:"Raspberry puree after fermentation." }
    ];

    let fermentationRecords = batches.map(b => ({
      batchId: b.batchId,
      beerStyle: b.beerStyle,
      tankId: b.tankId,
      fermentationStartDate: b.fermentationStartDate,
      currentGravity: b.currentGravity,
      status: b.status,
      gravityHistory: [
        `Day 1: ${(b.og - 0.010).toFixed(3)}`,
        `Day 3: ${(b.og - 0.020).toFixed(3)}`,
        `Day 7: ${(b.fg + 0.002).toFixed(3)}`
      ],
      actions: ["Dry hop on Day 5", "Diacetyl rest on Day 7"],
    }));

    let brewLogs = batches.map(b => ({ batchId: b.batchId, recipeName: b.recipeName, beerStyle: b.beerStyle, brewDate: b.brewDate, og: b.og, efficiency: b.brewhouseEfficiency, volume: b.volumeHl }));

    let filtrationRecords = [
      { batchId: "BREW-003", filterDate: "2024-12-15", method: "DE Filter", pre: 18.0, post: 17.2 },
      { batchId: "BREW-015", filterDate: "2024-12-20", method: "Plate Filter", pre: 20.5, post: 19.6 },
      { batchId: "BREW-028", filterDate: "2025-01-05", method: "Centrifuge", pre: 24.0, post: 23.4 },
      { batchId: "BREW-044", filterDate: "2025-02-02", method: "DE Filter", pre: 19.0, post: 18.3 },
      { batchId: "BREW-071", filterDate: "2025-02-10", method: "Centrifuge", pre: 25.0, post: 24.1 },
      { batchId: "BREW-088", filterDate: "2025-02-18", method: "Plate Filter", pre: 21.0, post: 20.2 }
    ];

    let finishedInventory = [
      { beerName: "West Coast Punch", beerStyle: "IPA", batches: "BREW-003, BREW-045", pack: "30L Kegs", qty: 48 },
      { beerName: "Citrus Haze", beerStyle: "Hazy IPA", batches: "BREW-028, BREW-066", pack: "440ml Cans", qty: 820 },
      { beerName: "Keller Gold", beerStyle: "Pilsner", batches: "BREW-015", pack: "500ml Bottles", qty: 620 },
      { beerName: "Velvet Stout", beerStyle: "Stout", batches: "BREW-071", pack: "30L Kegs", qty: 30 },
      { beerName: "Spring Saison", beerStyle: "Saison", batches: "BREW-088", pack: "375ml Bottles", qty: 280 }
    ];

    let packagingMaterials = [
      { item: "30L Keg", qty: 140, min: 80 },
      { item: "440ml Can", qty: 12000, min: 10000 },
      { item: "500ml Bottle", qty: 7600, min: 6000 },
      { item: "Labels - Citrus Haze", qty: 8500, min: 4000 },
      { item: "Can Ends", qty: 12500, min: 10000 }
    ];

    // Rendering helpers
    const sectionButtons = document.querySelectorAll('.nav-button');
    const sections = document.querySelectorAll('.section');
    sectionButtons.forEach(btn => btn.addEventListener('click', () => {
      sectionButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.section;
      sections.forEach(sec => sec.classList.toggle('active', sec.id === target));
      if (target === 'analytics') drawChart();
    }));

    // Dashboard rendering
    function renderDashboard() {
      const activeFerments = fermentationRecords.filter(f => f.status !== 'Complete');
      const totalBatches = batches.length;
      const avgEff = brewLogs.reduce((sum, b) => sum + b.efficiency, 0) / brewLogs.length;
      const totalVolume = brewLogs.reduce((sum, b) => sum + b.volume, 0);
      document.getElementById('kpiBatches').textContent = totalBatches;
      document.getElementById('kpiActive').textContent = activeFerments.length;
      document.getElementById('kpiEff').textContent = `${avgEff.toFixed(1)}%`;
      document.getElementById('kpiVolume').textContent = `${totalVolume.toFixed(1)} HL`;

      document.getElementById('efficiencyCard').textContent = `${avgEff.toFixed(1)}% average across brews.`;
      const totalTanks = 12;
      const tanksInUse = new Set(activeFerments.map(f => f.tankId)).size;
      const utilization = (tanksInUse / totalTanks) * 100;
      document.getElementById('tankUtilization').textContent = `${utilization.toFixed(0)}% of cellar in use (${tanksInUse}/${totalTanks})`;
      const today = new Date();
      const monthlyVolume = brewLogs.filter(b => (today - new Date(b.brewDate)) / (1000*60*60*24) <= 90)
        .reduce((sum, b) => sum + b.volume, 0);
      document.getElementById('monthlyVolume').textContent = `${monthlyVolume.toFixed(1)} HL brewed in the last 90 days.`;

      const activeBody = document.getElementById('activeFermentations');
      activeBody.innerHTML = activeFerments.slice(0, 8).map(f => {
        const days = Math.max(1, Math.floor((new Date() - new Date(f.fermentationStartDate)) / (1000*60*60*24)));
        const statusClass = f.status.includes('Slow') ? 'status-warn' : f.status === 'Complete' ? 'status-good' : 'status-good';
        return `<tr><td>${f.batchId}</td><td>${f.beerStyle}</td><td>${f.tankId}</td><td>${days}</td><td><span class="tag ${statusClass}">${f.status}</span></td></tr>`;
      }).join('');
    }

    function renderMaterials() {
      const tbody = document.getElementById('materialsTable');
      tbody.innerHTML = materials.map(m => {
        const low = Number(m.currentStock) < Number(m.minStock) ? 'low-stock' : '';
        return `<tr class="${low}"><td>${m.materialId}</td><td>${m.name}</td><td>${m.type}</td><td>${m.currentStock}</td><td>${m.minStock}</td><td>${m.supplier}</td><td>$${Number(m.unitCost).toFixed(2)}</td></tr>`;
      }).join('');
    }

    function renderRecipes() {
      const tbody = document.getElementById('recipesTable');
      tbody.innerHTML = recipes.map(r => `<tr data-id="${r.id}"><td>${r.id}</td><td>${r.name}</td><td>${r.style}</td><td>${r.version}</td><td>${r.og}</td><td>${r.fg}</td><td>${r.abv}%</td></tr>`).join('');
      Array.from(tbody.querySelectorAll('tr')).forEach(row => row.addEventListener('click', () => showRecipeDetail(row.dataset.id)));
    }

    function showRecipeDetail(id) {
      const r = recipes.find(x => x.id === id);
      if (!r) return;
      const detail = document.getElementById('recipeDetail');
      detail.innerHTML = `
        <div class="flex-between">
          <div><strong>${r.name}</strong> (v${r.version}) — ${r.style}</div>
          <button class="btn flat" onclick="cloneRecipe('${r.id}')">Clone Recipe</button>
        </div>
        <p class="muted">Target OG ${r.og}, FG ${r.fg}, ABV ${r.abv}%</p>
        <div class="grid-2">
          <div><strong>Malt Bill</strong><ul>${r.maltBill.map(m => `<li>${m.item}: ${m.amount}</li>`).join('')}</ul></div>
          <div><strong>Hop Schedule</strong><ul>${r.hopSchedule.map(h => `<li>${h.name} — ${h.time}</li>`).join('')}</ul></div>
        </div>
        <p><strong>Yeast:</strong> ${r.yeast}</p>
        <p><strong>Mash:</strong> ${r.mashSchedule}</p>
        <p class="muted">${r.notes}</p>`;
    }

    function cloneRecipe(id) {
      const original = recipes.find(r => r.id === id);
      if (!original) return;
      const newVersion = original.version + 1;
      const clone = { ...original, id: `${original.id}-C${newVersion}`, version: newVersion };
      recipes.push(clone);
      renderRecipes();
      showRecipeDetail(clone.id);
    }

    function renderBrewLogs(filterStyle = 'All') {
      const tbody = document.getElementById('brewTable');
      const filtered = filterStyle === 'All' ? brewLogs : brewLogs.filter(b => b.beerStyle === filterStyle);
      tbody.innerHTML = filtered.map(b => `<tr><td>${b.batchId}</td><td>${b.recipeName}</td><td>${b.beerStyle}</td><td>${b.brewDate}</td><td>${b.og.toFixed(3)}</td><td>${b.efficiency.toFixed(1)}%</td><td>${b.volume.toFixed(1)}</td></tr>`).join('');
    }

    function renderFermentations() {
      const tbody = document.getElementById('fermentationTable');
      tbody.innerHTML = fermentationRecords.slice(0, 60).map(f => {
        const days = Math.max(1, Math.floor((new Date() - new Date(f.fermentationStartDate)) / (1000*60*60*24)));
        return `<tr data-id="${f.batchId}"><td>${f.batchId}</td><td>${f.beerStyle}</td><td>${f.tankId}</td><td>${f.fermentationStartDate}</td><td>${days}</td><td>${f.currentGravity.toFixed(3)}</td><td>${f.status}</td></tr>`;
      }).join('');
      Array.from(tbody.querySelectorAll('tr')).forEach(row => row.addEventListener('click', () => showFermentationDetail(row.dataset.id)));
    }

    function showFermentationDetail(batchId) {
      const record = fermentationRecords.find(f => f.batchId === batchId);
      if (!record) return;
      const detail = document.getElementById('fermentationDetail');
      detail.innerHTML = `
        <div class="flex-between"><strong>${record.batchId} — ${record.beerStyle}</strong><span class="tag status-good">${record.status}</span></div>
        <p class="muted">Tank ${record.tankId} | Started ${record.fermentationStartDate}</p>
        <p><strong>Gravity Log:</strong> ${record.gravityHistory.join(', ')}</p>
        <p><strong>Actions:</strong> ${record.actions.join('; ')}</p>`;
    }

    function renderFiltration() {
      const tbody = document.getElementById('filtrationTable');
      tbody.innerHTML = filtrationRecords.map(f => {
        const yieldPct = (f.post / f.pre) * 100;
        return `<tr><td>${f.batchId}</td><td>${f.filterDate}</td><td>${f.method}</td><td>${f.pre.toFixed(1)}</td><td>${f.post.toFixed(1)}</td><td>${yieldPct.toFixed(1)}%</td></tr>`;
      }).join('');
    }

    function renderInventory() {
      const invBody = document.getElementById('inventoryTable');
      invBody.innerHTML = finishedInventory.map(i => `<tr><td>${i.beerName}</td><td>${i.beerStyle}</td><td>${i.batches}</td><td>${i.pack}</td><td>${i.qty}</td></tr>`).join('');
      const packBody = document.getElementById('packagingTable');
      packBody.innerHTML = packagingMaterials.map(p => `<tr><td>${p.item}</td><td>${p.qty}</td><td>${p.min}</td></tr>`).join('');
    }

    function renderAnalytics() {
      const abvList = document.getElementById('avgAbv');
      const effList = document.getElementById('avgEff');
      const volList = document.getElementById('totalVolume');
      abvList.innerHTML = '';
      effList.innerHTML = '';
      volList.innerHTML = '';
      beerStyles.forEach(style => {
        const styleBatches = batches.filter(b => b.beerStyle === style);
        if (styleBatches.length === 0) return;
        const avgAbv = styleBatches.reduce((s, b) => s + b.abv, 0) / styleBatches.length;
        const avgEff = styleBatches.reduce((s, b) => s + b.brewhouseEfficiency, 0) / styleBatches.length;
        const totalVol = styleBatches.reduce((s, b) => s + b.volumeHl, 0);
        abvList.innerHTML += `<li>${style}: ${avgAbv.toFixed(1)}% ABV</li>`;
        effList.innerHTML += `<li>${style}: ${avgEff.toFixed(1)}% brewhouse efficiency</li>`;
        volList.innerHTML += `<li>${style}: ${totalVol.toFixed(1)} HL</li>`;
      });
    }

    function drawChart() {
      const canvas = document.getElementById('volumeChart');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const padding = 40;
      const chartWidth = canvas.width - padding*2;
      const chartHeight = canvas.height - padding*2;
      const volumes = beerStyles.map(style => batches.filter(b => b.beerStyle === style).reduce((s,b)=>s+b.volumeHl,0));
      const maxVol = Math.max(...volumes) || 1;
      const barWidth = chartWidth / beerStyles.length - 6;
      ctx.strokeStyle = '#cbd5e1';
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, padding + chartHeight);
      ctx.lineTo(padding + chartWidth, padding + chartHeight);
      ctx.stroke();
      beerStyles.forEach((style, i) => {
        const x = padding + i * (barWidth + 6) + 4;
        const barHeight = (volumes[i] / maxVol) * chartHeight;
        const y = padding + chartHeight - barHeight;
        const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
        gradient.addColorStop(0, '#16a34a');
        gradient.addColorStop(1, '#22d3ee');
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth, barHeight);
        ctx.fillStyle = '#0f172a';
        ctx.font = '12px sans-serif';
        ctx.save();
        ctx.translate(x + barWidth/2, padding + chartHeight + 14);
        ctx.rotate(-0.35);
        ctx.fillText(style, -style.length*2.5, 0);
        ctx.restore();
        ctx.fillText(volumes[i].toFixed(0), x, y - 6);
      });
    }

    // Forms
    document.getElementById('materialForm').addEventListener('submit', e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      materials.unshift({ ...data, currentStock: Number(data.currentStock), minStock: Number(data.minStock), unitCost: Number(data.unitCost) });
      e.target.reset();
      renderMaterials();
    });

    document.getElementById('brewForm').addEventListener('submit', e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const newLog = {
        batchId: data.batchId,
        recipeName: data.recipeName,
        beerStyle: data.beerStyle,
        brewDate: data.brewDate,
        og: Number(data.og),
        efficiency: Number(data.efficiency),
        volume: Number(data.volume)
      };
      brewLogs.unshift(newLog);
      const newBatch = {
        batchId: data.batchId,
        recipeName: data.recipeName,
        beerStyle: data.beerStyle,
        brewDate: data.brewDate,
        og: newLog.og,
        fg: +(newLog.og - 0.012).toFixed(3),
        abv: +(((newLog.og - (newLog.og - 0.012)) * 131).toFixed(1)),
        volumeHl: newLog.volume,
        brewhouseEfficiency: newLog.efficiency,
        tankId: `F${Math.ceil(Math.random()*12).toString().padStart(2,'0')}`,
        fermentationStartDate: data.brewDate,
        fermentationDays: 1,
        currentGravity: +(newLog.og - 0.010).toFixed(3),
        status: 'Primary'
      };
      batches.unshift(newBatch);
      fermentationRecords.unshift({
        batchId: newBatch.batchId,
        beerStyle: newBatch.beerStyle,
        tankId: newBatch.tankId,
        fermentationStartDate: newBatch.fermentationStartDate,
        currentGravity: newBatch.currentGravity,
        status: newBatch.status,
        gravityHistory: [
          `Day 1: ${(newBatch.og - 0.010).toFixed(3)}`,
          `Day 3: ${(newBatch.og - 0.018).toFixed(3)}`,
          `Day 5: ${(newBatch.fg + 0.002).toFixed(3)}`
        ],
        actions: ["Dry hop scheduled Day 4"]
      });
      e.target.reset();
      renderBrewLogs(document.getElementById('brewFilter').value);
      renderFermentations();
      renderDashboard();
      renderAnalytics();
      drawChart();
    });

    // Brewing log filtering
    const brewFilter = document.getElementById('brewFilter');
    const brewStyleSelect = document.getElementById('brewStyle');
    beerStyles.forEach(style => {
      brewFilter.innerHTML += `<option value="${style}">${style}</option>`;
      brewStyleSelect.innerHTML += `<option value="${style}">${style}</option>`;
    });
    brewFilter.addEventListener('change', () => renderBrewLogs(brewFilter.value));

    // Search
    document.getElementById('searchBtn').addEventListener('click', handleSearch);
    document.getElementById('batchSearch').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleSearch(); }});
    function handleSearch() {
      const query = document.getElementById('batchSearch').value.trim().toUpperCase();
      const result = batches.find(b => b.batchId === query);
      const target = document.getElementById('searchResult');
      if (result) {
        target.textContent = `${result.batchId}: ${result.recipeName} (${result.beerStyle}) brewed on ${result.brewDate}, ${result.volumeHl} HL.`;
      } else {
        target.textContent = 'No batch found. Try BREW-001 ... BREW-100';
      }
    }

    function init() {
      renderDashboard();
      renderMaterials();
      renderRecipes();
      renderBrewLogs();
      renderFermentations();
      renderFiltration();
      renderInventory();
      renderAnalytics();
      drawChart();
    }

    init();
  </script>
</body>
</html>
